# 🏗️ 系统架构文档

## 概述

本系统是一个基于 RAG（Retrieval-Augmented Generation）的学术问答应用，采用双向量库架构，支持基础课程材料问答和用户自定义文档上传。

## 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                     Streamlit Web UI (app.py)               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ 问答界面     │  │ 文档上传界面 │  │ 文档管理界面 │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│                    核心业务层                                │
│  ┌──────────────────┐           ┌─────────────────┐        │
│  │  RAG System      │           │ Document Manager│        │
│  │  (rag_system.py) │◄─────────►│(document_manager│        │
│  │                  │           │       .py)      │        │
│  │ - 双向量库管理   │           │ - 文件上传      │        │
│  │ - 混合检索       │           │ - 元数据管理    │        │
│  │ - 文档索引       │           │ - 文件删除      │        │
│  └──────────────────┘           └─────────────────┘        │
│           ↓                              ↓                   │
│  ┌──────────────────┐           ┌─────────────────┐        │
│  │ Utils (utils.py) │           │ Utils (utils.py)│        │
│  │ - 文档处理       │           │ - 文件验证      │        │
│  │ - 格式化         │           │ - 哈希计算      │        │
│  └──────────────────┘           └─────────────────┘        │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│                      存储层                                  │
│  ┌──────────────────┐           ┌─────────────────┐        │
│  │  Vector Stores   │           │  File Storage   │        │
│  │                  │           │                 │        │
│  │ ./chroma_db/     │           │ ./UserUploads/  │        │
│  │  ├─ base/        │           │  ├─ *.pdf       │        │
│  │  └─ user/        │           │  └─ metadata.json│       │
│  └──────────────────┘           └─────────────────┘        │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│                   外部服务                                   │
│  ┌──────────────────┐           ┌─────────────────┐        │
│  │  OpenAI API      │           │  LangSmith      │        │
│  │  - Embeddings    │           │  (可选追踪)     │        │
│  │  - GPT-3.5       │           │                 │        │
│  └──────────────────┘           └─────────────────┘        │
└─────────────────────────────────────────────────────────────┘
```

## 模块说明

### 1. app.py - 主应用模块
**职责：**
- Streamlit UI 渲染
- 用户交互处理
- 会话状态管理
- 各模块协调

**主要功能：**
- 配置加载（Streamlit Secrets / 环境变量 / config.json）
- RAG 系统初始化
- 文档上传界面
- 文档管理界面
- 问答交互界面
- 历史记录展示

### 2. rag_system.py - RAG 核心模块
**职责：**
- 双向量库管理
- 文档索引和检索
- RAG 链构建

**核心类：**
- `DualVectorStoreRAG`: 双向量库管理器

**主要功能：**
- `initialize_base_vectorstore()`: 初始化基础向量库（课程材料）
- `initialize_user_vectorstore()`: 初始化用户向量库
- `add_user_document()`: 添加用户文档到向量库
- `remove_user_document()`: 从向量库删除文档
- `create_rag_chain()`: 创建 RAG 检索链（混合检索）

**核心函数：**
- `loadAndIndexFiles()`: 通用文档加载和索引函数
  - 被基础库和用户库共用
  - 支持批量处理
  - 自动添加元数据

### 3. document_manager.py - 文档管理模块
**职责：**
- 文件上传和验证
- 文件持久化存储
- 元数据管理
- 文件删除

**核心类：**
- `DocumentManager`: 文档管理器

**主要功能：**
- `upload_document()`: 上传和保存文档
  - 文件验证（格式、大小、内容）
  - 去重检查（基于 SHA256 哈希）
  - 生成唯一文件名
  - 保存元数据
- `delete_document()`: 删除文档及元数据
- `list_documents()`: 列出所有文档
- `mark_as_indexed()`: 标记文档为已索引

**元数据结构：**
```json
{
  "file_id": "20240101_120000_abc123_document.pdf",
  "original_filename": "document.pdf",
  "filepath": "UserUploads/20240101_120000_abc123_document.pdf",
  "size": 1048576,
  "size_formatted": "1.00 MB",
  "hash": "sha256_hash_value",
  "upload_time": "2024-01-01 12:00:00",
  "indexed": true
}
```

### 4. utils.py - 工具函数模块
**职责：**
- 通用工具函数
- 文件操作辅助
- 格式化和验证

**主要函数：**
- `generate_unique_filename()`: 生成唯一文件名
- `calculate_file_hash()`: 计算文件哈希（用于去重）
- `validate_pdf_file()`: PDF 文件验证
- `format_file_size()`: 格式化文件大小
- `get_directory_size()`: 计算目录大小
- `safe_remove_file()`: 安全删除文件

## 双向量库架构

### 设计理念
系统采用双向量库架构，将基础课程材料和用户上传文档分开管理：

```
Vector Stores:
├─ Base Vector Store (基础向量库)
│  ├─ 存储：./chroma_db/base/
│  ├─ 来源：CourseMaterials/deep_learning/
│  ├─ 特性：只读、缓存、高性能
│  └─ 用途：课程材料问答
│
└─ User Vector Store (用户向量库)
   ├─ 存储：./chroma_db/user/
   ├─ 来源：用户上传的 PDF 文件
   ├─ 特性：动态、可修改、持久化
   └─ 用途：自定义文档问答
```

### 优势
1. **性能优化**：基础库使用缓存，加载快速
2. **灵活管理**：用户文档可以动态添加/删除
3. **清晰隔离**：职责分明，易于维护
4. **可扩展性**：未来可以添加更多向量库（如多用户隔离）

### 检索流程
1. 用户提问
2. 同时从基础库和用户库检索（k=3）
3. 合并检索结果
4. 生成回答，并标记来源

## 文档处理流程

### 上传流程
```
1. 用户选择 PDF 文件
   ↓
2. 文件验证
   - 格式检查 (MIME type)
   - 大小检查 (< 50MB)
   - 内容检查 (PDF 魔术数字)
   ↓
3. 去重检查
   - 计算 SHA256 哈希
   - 与已有文档对比
   ↓
4. 保存文件
   - 生成唯一文件名
   - 保存到 UserUploads/
   - 记录元数据
   ↓
5. 文档索引
   - 加载 PDF (PyPDFLoader)
   - 分割文本 (RecursiveCharacterTextSplitter)
   - 向量化 (OpenAI Embeddings)
   - 添加到用户向量库
   ↓
6. 标记为已索引
   - 更新元数据
   - 完成上传
```

### 删除流程
```
1. 用户点击删除按钮
   ↓
2. 删除物理文件
   - 从 UserUploads/ 删除 PDF
   ↓
3. 从向量库删除
   - 通过元数据过滤
   - 删除相关向量
   ↓
4. 删除元数据记录
   - 更新 metadata.json
   ↓
5. 刷新 UI
```

## 数据流

### 问答数据流
```
用户问题
  ↓
RAG Chain
  ↓
混合检索器
  ├─ 基础向量库检索 (k=3)
  └─ 用户向量库检索 (k=3)
  ↓
文档合并和格式化
  - 添加来源标记
  - 添加页码信息
  ↓
Prompt Template
  ↓
OpenAI GPT-3.5
  ↓
生成回答
  ↓
显示给用户
  - 标记文档来源
  - 保存到历史记录
```

## 错误处理

### 文件上传错误
- 格式错误 → 友好提示，要求 PDF
- 文件过大 → 显示当前大小和限制
- 文件损坏 → 提示检查文件完整性
- 重复文件 → 显示已存在的文件信息

### 文档索引错误
- PDF 解析失败 → 提示可能是加密或损坏
- API 错误 → 提示检查网络和 API Key
- 向量化失败 → 详细错误信息和建议

### 向量库错误
- 初始化失败 → 检查目录权限
- 检索失败 → 降级到单库检索
- 持久化失败 → 警告但不中断服务

## 性能优化

### 缓存策略
1. **基础向量库缓存**：使用 `@st.cache_resource`
   - 只在首次加载或代码更新时重新初始化
   - 大幅提升启动速度

2. **配置缓存**：API Keys 缓存
   - 避免重复读取配置文件

### 批量处理
- `loadAndIndexFiles()` 支持批量处理多个文件
- 一次性向量化，减少 API 调用

### 进度反馈
- 使用 `st.spinner` 和 `st.status` 提供实时进度
- 分阶段显示处理状态

## 扩展性

### 未来可扩展功能
1. **多用户支持**
   - 在元数据中添加 user_id
   - 为每个用户创建独立的用户向量库
   - 通过 collection 或 metadata 过滤实现隔离

2. **更多文件格式**
   - 扩展 `loadAndIndexFiles()` 支持 Word、TXT、Markdown
   - 使用不同的 Loader（UnstructuredLoader）

3. **高级检索**
   - 实现重排序（Reranking）
   - 混合检索（关键词 + 语义）
   - 查询改写

4. **文档管理增强**
   - 文档标签系统
   - 文档搜索和过滤
   - 文档预览

5. **性能优化**
   - 异步处理（后台任务队列）
   - 本地缓存 embeddings
   - 使用更快的向量数据库（如 Qdrant）

## 部署建议

### 本地开发
```bash
# 1. 安装依赖
pip install -r requirements.txt

# 2. 配置 API Keys（选择一种方式）
# 方式 A: .streamlit/secrets.toml
cp .streamlit/secrets.toml.example .streamlit/secrets.toml
# 编辑并填入 Keys

# 方式 B: 环境变量
export OPENAI_API_KEY="your-key"

# 3. 运行应用
streamlit run app.py
```

### Streamlit Cloud 部署
1. 推送代码到 GitHub
2. 在 Streamlit Cloud 创建应用
3. 在 Secrets 中配置 API Keys
4. 自动部署

### 注意事项
- 用户上传的文件和向量库不会被提交到 Git（已加入 .gitignore）
- Streamlit Cloud 部署后，用户数据会在应用重启时丢失（除非使用外部存储）
- 生产环境建议使用外部向量数据库服务（如 Pinecone）

## 安全考虑

1. **API Keys 管理**
   - 使用 Streamlit Secrets 或环境变量
   - 永不硬编码在代码中

2. **文件验证**
   - 严格的文件格式和大小限制
   - 内容验证（魔术数字检查）

3. **文件去重**
   - 基于哈希值，防止恶意重复上传

4. **错误信息**
   - 不暴露敏感的系统信息
   - 提供友好的用户提示

## 故障排查

### 常见问题

**Q: 基础向量库初始化失败？**
A: 检查 CourseMaterials/deep_learning 目录是否存在且包含 PDF 文件

**Q: 用户文档上传成功但无法检索？**
A: 检查文档是否已标记为 indexed，查看向量库是否正常添加

**Q: 向量库在重启后丢失？**
A: 确认 persist_directory 路径正确，检查文件系统权限

**Q: 无法删除用户文档？**
A: 检查文件权限，确认元数据中的 file_id 正确

## 监控和日志

建议添加的监控点：
- 文档上传成功率
- 向量化处理时间
- 检索响应时间
- 向量库大小和文档数量
- 错误率和类型分布

## 总结

本系统通过模块化设计、双向量库架构和完善的错误处理，实现了一个功能完整、易于扩展的 RAG 学术问答系统。核心优势在于：

1. **清晰的模块划分**：易于维护和扩展
2. **双向量库设计**：兼顾性能和灵活性
3. **完善的文档管理**：上传、删除、元数据追踪
4. **友好的用户体验**：进度反馈、错误提示
5. **可扩展架构**：易于添加新功能

